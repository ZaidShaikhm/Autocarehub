{% extends 'autocareapp/userhomepage.html' %}
{% load static %}
{% block content %}

<div class="container py-5">
    <div class="row justify-content-center">
        <div class="col-lg-8">
            <div class="card border-0 shadow-sm">
                <div class="card-header bg-primary text-white rounded-top">
                    <h3 class="mb-0"><i class="bi bi-car-front me-2"></i>Vehicle Service Status</h3>
                </div>
                <div class="card-body">
                    <div class="mb-4">
                        <div class="input-group">
                            <input type="text" id="vehicle_number" class="form-control" 
                                   placeholder="Enter Vehicle Number (e.g. MH01AB1234)" required>
                            <button id="checkStatus" class="btn btn-gradient-primary">
                                <i class="bi bi-search me-2"></i>Check Status
                            </button>
                        </div>
                        <small class="text-muted">Enter your vehicle registration number to check service history</small>
                    </div>

                    <div id="loadingSpinner" class="text-center my-4 d-none">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                        <p class="mt-2">Fetching service records...</p>
                    </div>

                    <div id="statusResult" class="d-none">
                        <div class="d-flex justify-content-between align-items-center mb-3">
                            <h4 class="text-primary">Service History</h4>
                            <button id="printReport" class="btn btn-sm btn-outline-primary">
                                <i class="bi bi-printer me-1"></i>Print Report
                            </button>
                        </div>
                        <div class="service-history row">
                            <!-- Cards will be injected here by JS -->
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
    .btn-gradient-primary {
        background: linear-gradient(45deg, #0066cc, #00aaff);
        color: white;
        border: none;
        border-radius: 6px;
        padding: 8px 16px;
        font-weight: 500;
        transition: all 0.3s ease;
    }
    .btn-gradient-primary:hover {
        background: linear-gradient(45deg, #0055aa, #0099ee);
        box-shadow: 0 4px 8px rgba(0,102,204,0.2);
    }
    .card-title { font-size: 1.1rem; }
    .badge { font-size: 0.95em; }
    .bg-success { background-color: #28a745 !important; }
    .bg-warning { background-color: #ffc107 !important; color: #212529 !important; }
    .bg-danger { background-color: #dc3545 !important; }
    .bg-primary { background-color: #007bff !important; }
    .service-item { border-left: 4px solid #0066cc; background-color: #f8f9fa; transition: all 0.3s ease; }
    .service-item:hover { background-color: #f1f7ff; }
    #vehicle_number { text-transform: uppercase; }
</style>

<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

<script>
    $(document).ready(function(){
        $('#vehicle_number').on('input', function(){
            this.value = this.value.toUpperCase();
        });

        $('#checkStatus').click(function(){
            let vehicleNumber = $('#vehicle_number').val().trim();
            if(vehicleNumber === '') {
                Swal.fire({
                    icon: 'warning',
                    title: 'Vehicle Number Required',
                    text: 'Please enter your vehicle registration number',
                    confirmButtonColor: '#0066cc'
                });
                return;
            }

            $('#loadingSpinner').removeClass('d-none');
            $('#statusResult').addClass('d-none');

            $.ajax({
                url: "{% url 'get_service_status' %}",
                method: "GET",
                data: {
                    vehicle_number: vehicleNumber
                },
                success: function(response) {
                    $('#loadingSpinner').addClass('d-none');
                    if(response.success){
                        let html = '';
                        response.services.forEach(service => {
                            // Determine badge class based on status
                            let badgeClass = 'bg-secondary';
                            if(service.status.toLowerCase() === 'completed') {
                                badgeClass = 'bg-success';
                            } else if(service.status.toLowerCase() === 'in progress') {
                                badgeClass = 'bg-warning';
                            } else if(service.status.toLowerCase() === 'pending') {
                                badgeClass = 'bg-danger';
                            } else if(service.status.toLowerCase() === 'accepted') {
                                badgeClass = 'bg-primary';
                            } else if(service.status.toLowerCase() === 'cancelled') {
                                badgeClass = 'bg-danger';
                            }

                            // Get service amount - checking multiple possible field names
                            let amount = 'N/A';
                            if(service.amount !== undefined && service.amount !== null) {
                                amount = '₹' + service.amount;
                            } else if(service.price !== undefined && service.price !== null) {
                                amount = '₹' + service.price;
                            } else if(service.cost !== undefined && service.cost !== null) {
                                amount = '₹' + service.cost;
                            }

                            // Format date if needed
                            let serviceDate = service.date;
                            if(serviceDate.includes('T')) {
                                serviceDate = serviceDate.split('T')[0];
                            }

                            html += `
                            <div class="col-md-6 mb-4">
                                <div class="card shadow-sm h-100 service-item">
                                    <div class="card-body">
                                        <div class="d-flex justify-content-between align-items-center mb-2">
                                            <h5 class="card-title mb-0">${service.service_type || 'Service'}</h5>
                                            <span class="badge ${badgeClass}">${service.status}</span>
                                        </div>
                                        <p class="card-text mb-1"><strong>Description:</strong> ${service.description || 'No description available'}</p>
                                        <p class="card-text mb-1"><strong>Amount:</strong> ${amount}</p>
                                        <p class="card-text mb-1"><strong>Date:</strong> ${serviceDate}</p>
                                        ${service.mechanic_notes ? `<p class="card-text mb-1"><strong>Mechanic Notes:</strong> ${service.mechanic_notes}</p>` : ''}
                                    </div>
                                </div>
                            </div>`;
                        });

                        $('.service-history').html(html);
                        $('#statusResult').removeClass('d-none');
                        $('html, body').animate({
                            scrollTop: $('#statusResult').offset().top - 20
                        }, 500);
                        
                        // Add print functionality
                        $('#printReport').off('click').on('click', function() {
                            window.print();
                        });
                    } else {
                        Swal.fire({
                            icon: 'info',
                            title: 'No Records Found',
                            text: response.message,
                            confirmButtonColor: '#0066cc'
                        });
                    }
                },
                error: function(xhr) {
                    $('#loadingSpinner').addClass('d-none');
                    Swal.fire({
                        icon: 'error',
                        title: 'Error',
                        text: xhr.responseJSON?.error || 'Something went wrong. Please try again.',
                        confirmButtonColor: '#0066cc'
                    });
                }
            });
        });

        // Allow pressing Enter key to trigger search
        $('#vehicle_number').keypress(function(e) {
            if(e.which === 13) {
                $('#checkStatus').click();
            }
        });
    });
</script>
{% endblock %}